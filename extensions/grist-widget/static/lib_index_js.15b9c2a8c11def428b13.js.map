{"version":3,"file":"lib_index_js.15b9c2a8c11def428b13.js","mappings":"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","sources":["webpack://grist-widget/./src/index.ts","webpack://grist-widget/./src/initKernelPy.ts"],"sourcesContent":["import { JupyterFrontEnd, JupyterFrontEndPlugin } from '@jupyterlab/application';\nimport * as Comlink from 'comlink';\nimport initKernelPy from './initKernelPy';\nimport { IFileBrowserCommands } from '@jupyterlab/filebrowser';\n\nconst pendingWorkers: MyWorker[] = [];\n\nclass MyWorker extends Worker {\n  constructor(scriptURL: string | URL, options?: WorkerOptions) {\n    super(scriptURL, options);\n    const { grist } = (window as any);\n    if (grist) {\n      exposeWorker(this, grist);\n    } else {\n      pendingWorkers.push(this);\n    }\n  }\n}\n\nwindow.Worker = MyWorker;\n\nconst emptyNotebook = {\n  content: {\n    'metadata': {\n      'language_info': {\n        'codemirror_mode': {\n          'name': 'python',\n          'version': 3\n        },\n        'file_extension': '.py',\n        'mimetype': 'text/x-python',\n        'name': 'python',\n        'nbconvert_exporter': 'python',\n        'pygments_lexer': 'ipython3',\n        'version': '3.11'\n      },\n      'kernelspec': {\n        'name': 'python',\n        'display_name': 'Python (Pyodide)',\n        'language': 'python'\n      }\n    },\n    'nbformat_minor': 4,\n    'nbformat': 4,\n    'cells': [\n      {\n        'cell_type': 'code',\n        'source': '',\n        'metadata': {},\n        'execution_count': null,\n        'outputs': []\n      }\n    ]\n  },\n  format: 'json' as const,\n};\n\nlet currentRecord: any = null;\n\n/**\n * Initialization data for the grist-widget extension.\n */\nconst plugin: JupyterFrontEndPlugin<void> = {\n  id: 'grist-widget:plugin',\n  description: 'Custom Grist widget for a JupyterLite notebook',\n  autoStart: true,\n  requires: [IFileBrowserCommands],\n  activate: (app: JupyterFrontEnd) => {\n    hideBars(app).catch(e => console.error(e));\n\n    const script = document.createElement('script');\n    script.src = 'https://docs.getgrist.com/grist-plugin-api.js';\n    script.id = 'grist-plugin-api';\n    script.addEventListener('load', async () => {\n      const grist = (window as any).grist;\n\n      app.serviceManager.contents.fileChanged.connect(async (_, change) => {\n        if (change.type === 'save' && change.newValue?.path === 'notebook.ipynb') {\n          const withoutOutputs = {\n            ...change.newValue,\n            content: {\n              ...change.newValue.content,\n              cells: change.newValue.content.cells.map((cell: any) => ({\n                ...cell,\n                outputs: 'outputs' in cell ? [] : undefined,\n              })),\n            },\n          };\n          grist.setOption('notebook', withoutOutputs);\n        }\n      });\n\n      grist.onRecord((record: any) => {\n        currentRecord = record;\n      });\n\n      grist.ready();\n\n      const notebook = await grist.getOption('notebook') || emptyNotebook;\n      await app.serviceManager.contents.save('notebook.ipynb', notebook);\n      await app.commands.execute('filebrowser:open-path', { path: 'notebook.ipynb' });\n\n      console.log('JupyterLab extension grist-widget is activated!');\n\n      const kernel = await getKernel(app);\n      kernel.requestExecute({ code: initKernelPy() });\n\n      for (const worker of pendingWorkers) {\n        exposeWorker(worker, grist);\n      }\n\n      await app.commands.execute('notebook:run-all-cells');\n    });\n    document.head.appendChild(script);\n  }\n};\n\nasync function delay(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nfunction exposeWorker(worker: Worker, grist: any) {\n  Comlink.expose({\n    grist: {\n      ...grist,\n      getTable: (tableId: string) => Comlink.proxy(grist.getTable(tableId)),\n      getCurrentRecord: () => currentRecord,\n    }\n  }, worker);\n}\n\nasync function getKernel(app: JupyterFrontEnd) {\n  while (true) {\n    const widget = app.shell.currentWidget;\n    const kernel = (widget as any)?.context?.sessionContext?.session?.kernel;\n    if (kernel) {\n      return kernel;\n    }\n    await delay(100);\n  }\n}\n\nasync function hideBars(app: JupyterFrontEnd) {\n  while (!app.shell.currentWidget) {\n    await delay(100);\n  }\n  const shell = app.shell as any;\n  shell.collapseLeft();\n  shell._titleHandler.parent.setHidden(true);\n  shell._leftHandler.sideBar.setHidden(true);\n  for (let i = 0; i < 1000; i++) {\n    if (!shell.leftCollapsed) {\n      shell.collapseLeft();\n      shell._leftHandler.sideBar.setHidden(true);\n      break;\n    } else {\n      await delay(10);\n    }\n  }\n}\n\nexport default plugin;\n","function code() {\n  const packageUrl = new URL('../files/package.tar.gz', window.location.href).href;\n\n  // language=Python\n  return `\nasync def __bootstrap_grist(url):\n    from pyodide.http import pyfetch  # noqa\n    import io\n    import tarfile\n    \n    response = await pyfetch(url)\n    bytes_file = io.BytesIO(await response.bytes())\n    with tarfile.open(fileobj=bytes_file) as tar:\n        tar.extractall()\n    \n    import grist.browser  # noqa\n    return grist.browser.grist\n\ngrist = await __bootstrap_grist(${JSON.stringify(packageUrl)})\n`;\n}\n\nexport default code;\n"],"names":[],"sourceRoot":""}